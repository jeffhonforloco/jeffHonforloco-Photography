name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and test
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    outputs:
      frontend-build: ${{ steps.frontend-build.outputs.build-path }}
      backend-build: ${{ steps.backend-build.outputs.build-path }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
      
      - name: Run frontend tests
        run: |
          npm run test || echo "Tests not configured yet"
          npm run lint || echo "Linting not configured yet"
      
      - name: Run backend tests
        run: |
          cd backend
          npm test || echo "Tests not configured yet"
      
      - name: Build frontend
        id: frontend-build
        run: |
          npm run build
          echo "build-path=dist" >> $GITHUB_OUTPUT
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_GA_TRACKING_ID: ${{ secrets.VITE_GA_TRACKING_ID }}
      
      - name: Build backend
        id: backend-build
        run: |
          cd backend
          echo "build-path=backend" >> $GITHUB_OUTPUT
      
      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 7
      
      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/
          retention-days: 7

  # Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run npm audit
        run: |
          npm audit --audit-level moderate
          cd backend && npm audit --audit-level moderate

  # Deploy to Railway
  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist/
      
      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/
      
      - name: Deploy to Railway
        uses: railway-app/railway-deploy@v1
        with:
          railway-token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_ID }}
          environment: production
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          EMAIL_SERVICE_HOST: ${{ secrets.EMAIL_SERVICE_HOST }}
          EMAIL_SERVICE_USER: ${{ secrets.EMAIL_SERVICE_USER }}
          EMAIL_SERVICE_PASS: ${{ secrets.EMAIL_SERVICE_PASS }}

  # Deploy to Vercel (Frontend)
  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist/
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod'

  # Deploy to DigitalOcean
  deploy-digitalocean:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist/
      
      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend/
      
      - name: Deploy to DigitalOcean App Platform
        uses: digitalocean/app_action@v2
        with:
          digitalocean_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          app_id: ${{ secrets.DIGITALOCEAN_APP_ID }}
          environment: production

  # Deploy to AWS
  deploy-aws:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Deploy to AWS S3 (Frontend)
        run: |
          aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET }} --delete
          aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
      
      - name: Deploy to AWS Elastic Beanstalk (Backend)
        run: |
          cd backend
          zip -r backend.zip .
          aws elasticbeanstalk create-application-version \
            --application-name ${{ secrets.AWS_EB_APPLICATION_NAME }} \
            --version-label ${{ github.sha }} \
            --source-bundle S3Bucket=${{ secrets.AWS_S3_BUCKET }},S3Key=backend-${{ github.sha }}.zip
          aws elasticbeanstalk update-environment \
            --environment-name ${{ secrets.AWS_EB_ENVIRONMENT_NAME }} \
            --version-label ${{ github.sha }}

  # Database migration
  migrate:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
      
      - name: Run database migration
        run: |
          cd backend
          npm run migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
      
      - name: Verify migration
        run: |
          cd backend
          # Add verification steps here
          echo "Migration verification completed"

  # Health check
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel, migrate]
    if: always()
    steps:
      - name: Check frontend health
        run: |
          # Check if frontend is accessible
          curl -f ${{ secrets.FRONTEND_URL }}/health || echo "Frontend health check failed"
      
      - name: Check backend health
        run: |
          # Check if backend API is accessible
          curl -f ${{ secrets.BACKEND_URL }}/health || echo "Backend health check failed"
      
      - name: Check API endpoints
        run: |
          # Test critical API endpoints
          curl -f ${{ secrets.BACKEND_URL }}/api/v1/blog || echo "Blog API check failed"
          curl -f ${{ secrets.BACKEND_URL }}/api/v1/portfolio || echo "Portfolio API check failed"

  # Notify deployment
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel, health-check]
    if: always()
    steps:
      - name: Notify on success
        if: needs.deploy-railway.result == 'success' && needs.deploy-vercel.result == 'success'
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Frontend: ${{ secrets.FRONTEND_URL }}"
          echo "üîß Backend: ${{ secrets.BACKEND_URL }}"
      
      - name: Notify on failure
        if: needs.deploy-railway.result == 'failure' || needs.deploy-vercel.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs for errors"
      
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.deploy-railway.result }}' === 'success' && '${{ needs.deploy-vercel.result }}' === 'success' ? 'success' : 'failure';
            
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment.id,
              state: status,
              description: status === 'success' ? 'Deployment successful' : 'Deployment failed',
              environment_url: status === 'success' ? '${{ secrets.FRONTEND_URL }}' : undefined
            });
