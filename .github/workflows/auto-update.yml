name: Auto Update Dependencies

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - security
          - minor
          - major

env:
  NODE_VERSION: '18'

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Update Frontend Dependencies
        run: |
          echo "Updating frontend dependencies..."
          
          # Update package.json dependencies
          npm update
          
          # Update specific packages if needed
          npm install @types/node@latest
          npm install typescript@latest
          npm install vite@latest
          
          # Security updates
          npm audit fix --force
          
          # Check for outdated packages
          npm outdated || echo "No outdated packages found"
      
      - name: Update Backend Dependencies
        run: |
          echo "Updating backend dependencies..."
          cd backend
          
          # Update package.json dependencies
          npm update
          
          # Update specific packages if needed
          npm install express@latest
          npm install nodemailer@latest
          npm install better-sqlite3@latest
          
          # Security updates
          npm audit fix --force
          
          # Check for outdated packages
          npm outdated || echo "No outdated packages found"
      
      - name: Update Documentation
        run: |
          echo "Updating documentation..."
          
          # Update README with latest versions
          if [ -f README.md ]; then
            echo "## Last Updated: $(date)" >> README.md
          fi
          
          # Update package versions in documentation
          echo "Dependencies updated on $(date)" > .github/LAST_UPDATE.md
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: automated dependency updates
            
            - Updated frontend dependencies
            - Updated backend dependencies
            - Applied security patches
            - Updated documentation
          title: 'ü§ñ Automated Dependency Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated updates to keep dependencies current and secure.
            
            ### Changes Made
            - ‚úÖ Updated frontend dependencies
            - ‚úÖ Updated backend dependencies  
            - ‚úÖ Applied security patches
            - ‚úÖ Updated documentation
            
            ### Security Updates
            - Applied `npm audit fix` to both frontend and backend
            - Updated vulnerable packages
            - Applied latest security patches
            
            ### Review Required
            - [ ] Test frontend functionality
            - [ ] Test backend API endpoints
            - [ ] Verify email service still works
            - [ ] Check for breaking changes
            
            ### Testing
            Please test the following:
            - [ ] Frontend builds successfully
            - [ ] Backend starts without errors
            - [ ] Contact form submissions work
            - [ ] Admin panel functions correctly
            - [ ] Email service is operational
            
            ---
            *This PR was created automatically by GitHub Actions*
          branch: automated-dependency-updates
          delete-branch: true
          labels: |
            automated
            dependencies
            security
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: update-dependencies
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security audit
        run: |
          echo "Running security audit..."
          
          # Frontend security audit
          npm audit --audit-level moderate
          
          # Backend security audit
          cd backend
          npm audit --audit-level moderate
      
      - name: Check for vulnerabilities
        run: |
          echo "Checking for known vulnerabilities..."
          
          # Check for high/critical vulnerabilities
          npm audit --audit-level high || echo "High severity vulnerabilities found"
          cd backend
          npm audit --audit-level high || echo "High severity vulnerabilities found"

  notify:
    name: Notify Updates
    runs-on: ubuntu-latest
    needs: [update-dependencies, security-scan]
    if: always()
    steps:
      - name: Notify on success
        if: needs.update-dependencies.result == 'success'
        run: |
          echo "‚úÖ Dependency updates completed successfully"
          echo "üì¶ New packages updated"
          echo "üîí Security patches applied"
      
      - name: Notify on failure
        if: needs.update-dependencies.result == 'failure'
        run: |
          echo "‚ùå Dependency updates failed"
          echo "Please check the logs for errors"
      
      - name: Create issue on failure
        if: needs.update-dependencies.result == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Automated Dependency Update Failed',
              body: `
              The automated dependency update process failed.
              
              **Error Details:**
              - Workflow: ${{ github.workflow }}
              - Run ID: ${{ github.run_id }}
              - Commit: ${{ github.sha }}
              
              **Next Steps:**
              1. Check the workflow logs for errors
              2. Manually update dependencies if needed
              3. Fix any breaking changes
              4. Re-run the workflow
              
              **Workflow URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `,
              labels: ['bug', 'dependencies', 'automated']
            })
